{"version":3,"file":"vizConnector.js","sourceRoot":"./src/","sources":["vizConnector.js"],"names":[],"mappings":"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","sourcesContent":["/**\n * Connect to viz.furo.pro to visualize your running application.\n *\n * ### Usage\n * ```js\n *\n * viz() // starts the rendering at document.body\n *\n * viz($0) // starts the rendering at the selected element (chrome)\n *\n * ```\n *\n * Set `window._viz.url` to change the viz instance. Default goes to  'https://viz.furo.pro/'\n *\n * @param root DomNode The root node to start the rendering.\n */\n\nimport { FbpBreakpoints } from './FbpBreakpoints.js';\n\nwindow._viz = {\n  url: 'https://viz.furo.pro/',\n};\n\nconst bp = JSON.parse(sessionStorage.getItem('__fbp_breakpoints'));\nFbpBreakpoints.SetBreakpoints(bp || []);\n\nwindow.onmessage = m => {\n  if (m.data.type === 'PARENT_REFRESHED') {\n    // STEP 3\n    window._viz.visualizer = m.source;\n    window._viz.url = m.data.url;\n    // notify viz\n    window._viz.visualizer.postMessage('PARENT_RECONNECTED', window._viz.url);\n    // eslint-disable-next-line no-use-before-define\n    messages();\n    // eslint-disable-next-line no-console\n    console.log('VIZ Reconnected');\n  }\n};\n\nwindow.addEventListener('beforeunload', () => {\n  if (window._viz.visualizer) {\n    // STEP 1\n    window._viz.visualizer.postMessage('PARENT_REFRESHING', window._viz.url);\n    // eslint-disable-next-line no-console\n    console.log('PARENT_REFRESHING');\n  }\n});\n\nwindow.viz = root => {\n  const visualizer = window.open(window._viz.url);\n  window._viz.visualizer = visualizer;\n  // build flat node list and register events\n  // eslint-disable-next-line no-use-before-define\n  messages(root);\n};\n\nfunction messages(root) {\n  if (root === undefined) {\n    // eslint-disable-next-line no-param-reassign\n    root = window.document.body;\n  }\n\n  window.onmessage = m => {\n    if (m.data.type === 'COMPONENT_REQUEST') {\n      const node = FbpBreakpoints.GetElementByPath(m.data.path);\n\n      window._viz.visualizer.postMessage(\n        {\n          type: 'RENDER_REQUEST',\n          data: node.shadowRoot?.innerHTML || node.innerHTML,\n          component: node.tagName,\n          path: FbpBreakpoints.getDomPath(node),\n        },\n        window._viz.url\n      );\n      // eslint-disable-next-line no-console\n      console.log('render request for ', node.tagName);\n    }\n    if (m.data.type === 'PARENT_COMPONENT_REQUEST') {\n      const stack = m.data.path.split(' > ');\n      // todo rewind until next shadow host\n      while (\n        !stack[stack.length - 1].endsWith('::shadow') &&\n        stack.length > 1\n      ) {\n        stack.pop();\n      }\n\n      // remove shadow from last element\n      stack[stack.length - 1] = stack[stack.length - 1].replace('::shadow', '');\n      const path = stack.join(' > ');\n\n      const node = FbpBreakpoints.GetElementByPath(path);\n      let data = '';\n      if (node.shadowRoot) {\n        data = node.shadowRoot.innerHTML;\n      } else {\n        data = node.innerHTML;\n      }\n\n      window._viz.visualizer.postMessage(\n        {\n          type: 'RENDER_REQUEST',\n          data,\n          component: node.tagName,\n          path: FbpBreakpoints.getDomPath(node),\n        },\n        window._viz.url\n      );\n      // eslint-disable-next-line no-console\n      console.log('render request for ', FbpBreakpoints.GetElementByPath(path));\n    }\n\n    if (m.data.type === 'BREAKPOINTS') {\n      FbpBreakpoints.SetBreakpoints(m.data.breakpoints);\n      sessionStorage.setItem(\n        '__fbp_breakpoints',\n        JSON.stringify(m.data.breakpoints)\n      );\n    }\n\n    if (m.data.type === 'ANALYZER_READY') {\n      let data = root.innerHTML;\n      if (root.shadowRoot && root.shadowRoot.innerHTML) {\n        data = root.shadowRoot.innerHTML;\n      }\n      // for elements created with domfbp\n      if (root.vizRoot) {\n        data = root.vizRoot.innerHTML;\n      }\n\n      window._viz.visualizer.postMessage(\n        {\n          type: 'BREAKPOINTS',\n          breakpoints: FbpBreakpoints.Breakpoints(),\n        },\n        window._viz.url\n      );\n\n      window._viz.visualizer.postMessage(\n        {\n          type: 'RENDER_REQUEST',\n          data,\n          component: root.tagName,\n          path: FbpBreakpoints.getDomPath(root),\n        },\n        window._viz.url\n      );\n    }\n  };\n}\n"]}